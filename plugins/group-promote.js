const config = require('../config')
const { cmd, commands } = require('../command')
const { getBuffer, getGroupAdmins, getRandom, h2k, isUrl, Json, runtime, sleep, fetchJson} = require('../lib/functions')

cmd({
    pattern: "promote",
    react: "üí´",
    alias: ["addadmin"],
    desc: "Promote a user to admin.",
    category: "group",
    filename: __filename
}, async (conn, mek, m, {
    from,
    quoted,
    isGroup,
    isAdmins,
    isOwner,
    participants,
    isBotAdmins,
    reply
}) => {
    try {
        if (!isGroup) return reply("‚ùå This command can only be used in groups.");
        if (!isAdmins && !isOwner) return reply("‚ùå Only group admins or the owner can use this command.");
        if (!isBotAdmins) return reply("‚ùå I need admin privileges to promote members.");

        // ‚û°Ô∏è D√©tecter le participant √† promouvoir (en r√©ponse ou mention)
        let target;
        if (m.quoted) {
            target = m.quoted.sender;
        } else if (m.mentionedJid && m.mentionedJid.length > 0) {
            target = m.mentionedJid[0];
        } else if (m.msg && m.msg.contextInfo && m.msg.contextInfo.mentionedJid && m.msg.contextInfo.mentionedJid.length > 0) {
            target = m.msg.contextInfo.mentionedJid[0];
        }

        if (!target) return reply("‚ùå Please mention or reply to a user to promote.");

        // ‚û°Ô∏è V√©rifier si l'utilisateur est d√©j√† admin
        const isAlreadyAdmin = participants.some(p => p.id === target && p.admin !== null);
        if (isAlreadyAdmin) return reply("‚ùó User is already an admin.");

        // ‚û°Ô∏è Promouvoir le participant
        await conn.groupParticipantsUpdate(from, [target], "promote")
            .catch(err => {
                console.error(`‚ö†Ô∏è Failed to promote ${target}:`, err);
                return reply("‚ùå An error occurred while promoting the participant.");
            });

        // ‚û°Ô∏è Extraire le tag √† partir du JID
        const tag = target.split('@')[0];
        reply(`*_@${tag} promoted successfully_*`, { mentions: [target] });

    } catch (error) {
        console.error('Error while executing promote:', error);
        reply('‚ùå An error occurred while executing the command.');
    }
});
